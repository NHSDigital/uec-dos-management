name: Deploy Application workflow

on:
  workflow_call:
    inputs:
      directory:
        description: "The name of the directory to deploy into"
        required: true
        type: string
      environment:
        description: "The name of the environment to deploy into"
        required: true
        type: string
      domain:
          description: "The name of the domain to deploy from. If not supplied, we will deploy from the domain that has invoked the workflow"
          required: false
          default: ""
          type: string
      workspace:
        description: "The name of the workspace to deploy the application into"
        required: true
        type: string
      services:
        description: "A list of the services to build and deploy. All services can be deployed by specifying 'all' "
        required: false
        default: ""
        type: string
      tag:
        description: "The tag to build and deploy from"
        required: false
        default: ""
        type: string
      workflow_timeout:
        description: "Timeout duration in minutes"
        required: false
        default: 5
        type: number
      commit_hash:
        description: "Git commit hash - to locate artefacts"
        required: true
        type: string
      artefact_bucket_name:
        description: "Name of s3 repo holding domain artefacts"
        required: true
        type: string

jobs:
  derive-service-names:
    name: "Derive Service Names"
    runs-on: ubuntu-latest
    outputs:
        services: ${{ steps.derive-service-names.outputs.services }}
    steps:
      - name: "Checkout code"
        uses: NHSDigital/uec-dos-management/.github/actions/checkout-repository@task/DR-930_Implement_appdeploy_intenv
        with:
          repository: ${{ inputs.domain }}
          tag: ${{ inputs.tag }}

      - name: Derive Service Names
        id: derive-service-names
        shell: bash
        run: |
          if [ ${{ inputs.services }} == 'all' ]; then
            cd ${{ inputs.directory }}
            SERVICES=$(ls | jq -R -s -c 'split("\n")[:-1]')
            echo "services=${SERVICES}" >> $GITHUB_OUTPUT
          else
            echo "services=${{ fromJSON(inputs.services) }}" >> $GITHUB_OUTPUT
          fi

  output-service-names:
    name: "output Service Names"
    runs-on: ubuntu-latest
    needs:
      [
        derive-service-names
      ]
    steps:

      - name: output Service Names
        shell: bash
        run: |
            echo ${{ fromJSON(needs.derive-service-names.outputs.services) }}

  derive-commit-hash:
    name: Derive Commit Hash
    runs-on: ubuntu-latest
    outputs:
        commit_hash: ${{ steps.derive-commit-hash.outputs.commit_hash }}
    steps:
      - name: "Checkout code"
        uses: NHSDigital/uec-dos-management/.github/actions/checkout-repository@task/DR-930_Implement_appdeploy_intenv
        with:
          repository: ${{ inputs.domain }}

      - name: Derive Commit Hash
        id: derive-commit-hash
        shell: bash
        run: |
          if [ ${{ inputs.commit_hash}} == 'latest' ]; then
            echo LATEST_HASH=$(git rev-parse main)
            echo "commit_hash=${LATEST_HASH}" >> $GITHUB_OUTPUT
          else
            echo "commit_hash=${{ inputs.commit_hash }}" >> $GITHUB_OUTPUT
          fi

  deploy-application:
    name: "Deploy Application"
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    permissions:
      id-token: write
      contents: read
    timeout-minutes: ${{ inputs.workflow_timeout }}
    needs:
      [
        derive-service-names,
        derive-commit-hash
      ]
    strategy:
      matrix:
        service: ${{ fromJSON(needs.derive-service-names.outputs.services) }}

    steps:
      - name: "Checkout code"
        uses: NHSDigital/uec-dos-management/.github/actions/checkout-repository@task/DR-930_Implement_appdeploy_intenv
        with:
          repository: ${{ inputs.domain }}
          tag: ${{ inputs.tag }}

      - name: Configure AWS Credentials
        uses: NHSDigital/uec-dos-management/.github/actions/configure-credentials@task/DR-930_Implement_appdeploy_intenv
        with:
          aws_account_id: ${{ secrets.ACCOUNT_ID }}
          aws_region: ${{ vars.AWS_REGION }}
          domain: ${{ inputs.domain }}

      - name: "Deploy service"
        uses: NHSDigital/uec-dos-management/.github/actions/deploy-service@task/DR-930_Implement_appdeploy_intenv
        with:
          service: ${{ matrix.service }}
          directory: ${{ inputs.directory }}
          environment: ${{ inputs.environment }}
          workspace: ${{ inputs.workspace }}
          commit_hash: ${{ inputs.commit_hash }}
          artefact_bucket_name: ${{ inputs.artefact_bucket_name }}
