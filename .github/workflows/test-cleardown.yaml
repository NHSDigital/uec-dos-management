name: Test Cleardown Workflow

on:
  delete:
    branches:
        - 'task/*'

jobs:
    destroy:
        if: github.event.ref_type == 'branch' && startswith(github.event.ref, 'task/') && github.actor != 'github-merge-queue[bot]'
        uses: ./.github/workflows/infrastructure-cleardown.yaml
        with:
          github_environment: mgmt
          branch_name: ${{ github.event.ref }}
        secrets: inherit
    summarise:
        if: github.event.ref_type == 'branch' && startswith(github.event.ref, 'task/') && github.actor != 'github-merge-queue[bot]'
        runs-on: ubuntu-latest
        steps:
        - name: Summary
          run: |
                echo "${{ github.actor }} deleted a task branch..."
                echo "triggering cleardown of infra in mgmt account relating to ${{ github.ref_type }}: ${{ github.event_ref }}"

# on:
#   push:
#     branches:
#       - main
#       - 'task/*'

# jobs:
#   metadata:
#     name: "Get Metadata"
#     uses: ./.github/workflows/metadata.yaml

#   deploy-infrastructure-apply:
#     name: "Apply Deploy Infrastructure"
#     needs:
#       [
#         metadata,
#       ]
#     uses: ./.github/workflows/deploy-infrastructure.yaml
#     with:
#       environment: mgmt
#       workspace: ${{ needs.metadata.outputs.workspace }}
#       domain: "uec-dos-management"
#       stacks: "['test-stack-1']"
#       action: apply
#     secrets: inherit

#   cleardown:
#       name: "Cleardown Infrastructure"
#       needs:
#         [
#           metadata,
#           deploy-infrastructure-apply,
#         ]
#       uses: ./.github/workflows/infrastructure-cleardown.yaml
#       with:
#         environment: mgmt
#         workspace: ${{ needs.metadata.outputs.workspace }}
#         domain: "uec-dos-management"
#         stacks: "['test-stack-1']"
#       secrets: inherit
